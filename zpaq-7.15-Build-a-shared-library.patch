From 66777ca64d817c7b08fe20155eab3e392c03a6ea Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= <ppisar@redhat.com>
Date: Tue, 12 Apr 2016 15:28:46 +0200
Subject: [PATCH] Build a shared library
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Petr Písař <ppisar@redhat.com>
---
 Makefile | 34 +++++++++++++++++++++++++---------
 1 file changed, 25 insertions(+), 9 deletions(-)

diff --git a/Makefile b/Makefile
index 410e444..8fa7cff 100644
--- a/Makefile
+++ b/Makefile
@@ -3,34 +3,50 @@ CPPFLAGS+=-Dunix
 # CPPFLAGS+=NOJIT
 CXXFLAGS=-O3 -march=native
 PREFIX=/usr/local
+LIBDIR=$(PREFIX)/lib
+INCLUDEDIR=$(PREFIX)/include
 BINDIR=$(PREFIX)/bin
 MANDIR=$(PREFIX)/share/man
+SONAME=libzpaq.so.0.1
 
-all: zpaq zpaq.1
+all: $(SONAME) zpaq zpaq.1
 
 libzpaq.o: libzpaq.cpp libzpaq.h
-	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -o $@ -c libzpaq.cpp
+	$(CXX) -fPIC -DPIC $(CPPFLAGS) $(CXXFLAGS) -o $@ -c libzpaq.cpp
+
+$(SONAME): libzpaq.o
+	$(CXX) $(LDFLAGS) -shared -Wl,-soname,$(SONAME) -o $@ $<
+
+libzpaq.so: $(SONAME)
+	rm -f libzpaq.so
+	ln -s $(SONAME) libzpaq.so
 
 zpaq.o: zpaq.cpp libzpaq.h
 	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -o $@ -c zpaq.cpp -pthread
 
-zpaq: zpaq.o libzpaq.o
-	$(CXX) $(LDFLAGS) -o $@ zpaq.o libzpaq.o -pthread
+zpaq: zpaq.o libzpaq.so
+	$(CXX) $(LDFLAGS) -o $@ zpaq.o -L. -lzpaq -pthread
 
 zpaq.1: zpaq.pod
 	pod2man $< >$@
 
-install: zpaq zpaq.1
+install: $(SONAME) libzpaq.h zpaq zpaq.1
+	install -m 0755 -d $(DESTDIR)$(LIBDIR)
+	install -m 0755 $(SONAME) $(DESTDIR)$(LIBDIR)
+	rm -f $(DESTDIR)$(LIBDIR)/libzpaq.so
+	ln -s $(SONAME) $(DESTDIR)$(LIBDIR)/libzpaq.so
+	install -m 0755 -d $(DESTDIR)$(INCLUDEDIR)
+	install -m 0644 libzpaq.h $(DESTDIR)$(INCLUDEDIR)
 	install -m 0755 -d $(DESTDIR)$(BINDIR)
 	install -m 0755 zpaq $(DESTDIR)$(BINDIR)
 	install -m 0755 -d $(DESTDIR)$(MANDIR)/man1
 	install -m 0644 zpaq.1 $(DESTDIR)$(MANDIR)/man1
 
 clean:
-	rm -f zpaq.o libzpaq.o zpaq zpaq.1 archive.zpaq zpaq.new
+	rm -f zpaq.o libzpaq.o libzpaq.so $(SONAME) zpaq zpaq.1 archive.zpaq zpaq.new
 
-check: zpaq
-	./zpaq add archive.zpaq zpaq
-	./zpaq extract archive.zpaq zpaq -to zpaq.new
+check: zpaq $(SONAME)
+	LD_LIBRARY_PATH=. ./zpaq add archive.zpaq zpaq
+	LD_LIBRARY_PATH=. ./zpaq extract archive.zpaq zpaq -to zpaq.new
 	cmp zpaq zpaq.new
 	rm archive.zpaq zpaq.new
-- 
2.7.4
